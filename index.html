<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerr Black Hole Simulation</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div id="controls">
            <h2>Kerr Black Hole</h2>
            
            <div class="control-group">
                <label for="spin-slider">
                    Spin (a/M): <span id="spin-value">0.90</span>
                </label>
                <input type="range" id="spin-slider" min="0" max="0.99" step="0.01" value="0.90">
            </div>
            
            <div class="control-group">
                <label for="resolution-toggle">
                    <input type="checkbox" id="resolution-toggle" checked>
                    High Quality (1080p)
                </label>
            </div>
            
            <div class="control-group">
                <label for="distance-slider">
                    Distance: <span id="distance-value">20</span>
                </label>
                <input type="range" id="distance-slider" min="5" max="80" step="1" value="20">
            </div>
            
            <div class="control-group">
                <label for="theta-slider">
                    Theta (horizontal): <span id="theta-value">180</span>°
                </label>
                <input type="range" id="theta-slider" min="-180" max="180" step="1" value="180">
            </div>
            
            <div class="control-group">
                <label for="phi-slider">
                    Phi (vertical): <span id="phi-value">-79</span>°
                </label>
                <input type="range" id="phi-slider" min="-85" max="85" step="1" value="-79">
            </div>
            
            <div class="info">
                <p><strong>Controls:</strong></p>
                <ul>
                    <li>Drag: Rotate camera</li>
                    <li>Scroll: Zoom in/out</li>
                </ul>
            </div>
            
            <div class="physics-info">
                <p><strong>Physics:</strong></p>
                <ul>
                    <li>Event Horizon: r<sub>H</sub> = <span id="horizon-radius">1.44</span>M</li>
                    <li>ISCO: r<sub>ISCO</sub> = <span id="isco-radius">2.32</span>M</li>
                </ul>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner"></div>
            <p>Loading WebGPU...</p>
        </div>
    </div>

    <script type="module">
        // Check WebGPU support
        if (!navigator.gpu) {
            document.getElementById('loading').innerHTML = `
                <p style="color: #ff6b6b;">WebGPU is not supported in your browser.</p>
                <p>Please use Chrome 113+, Edge 113+, or Firefox Nightly with WebGPU enabled.</p>
            `;
            throw new Error('WebGPU not supported');
        }

        // Import and run WASM module
        import init from './pkg/blackhole_simulation.js';
        
        async function run() {
            await init();
            
            // Hide loading screen
            document.getElementById('loading').style.display = 'none';
            
            // Set up UI event handlers
            const spinSlider = document.getElementById('spin-slider');
            const spinValue = document.getElementById('spin-value');
            const horizonRadius = document.getElementById('horizon-radius');
            const iscoRadius = document.getElementById('isco-radius');
            
            function updatePhysicsInfo(spin) {
                const a = parseFloat(spin);
                
                // Event horizon: r_H = 1 + sqrt(1 - a²)
                const rH = 1 + Math.sqrt(1 - a * a);
                horizonRadius.textContent = rH.toFixed(2);
                
                // ISCO calculation
                const z1 = 1 + Math.pow(1 - a * a, 1/3) * (Math.pow(1 + a, 1/3) + Math.pow(1 - a, 1/3));
                const z2 = Math.sqrt(3 * a * a + z1 * z1);
                const rISCO = 3 + z2 - Math.sqrt((3 - z1) * (3 + z1 + 2 * z2));
                iscoRadius.textContent = rISCO.toFixed(2);
            }
            
            spinSlider.addEventListener('input', (e) => {
                const spin = parseFloat(e.target.value).toFixed(2);
                spinValue.textContent = spin;
                updatePhysicsInfo(spin);
            });
            
            // Camera sliders
            const distanceSlider = document.getElementById('distance-slider');
            const distanceValue = document.getElementById('distance-value');
            const thetaSlider = document.getElementById('theta-slider');
            const thetaValue = document.getElementById('theta-value');
            const phiSlider = document.getElementById('phi-slider');
            const phiValue = document.getElementById('phi-value');
            
            distanceSlider.addEventListener('input', (e) => {
                distanceValue.textContent = e.target.value;
            });
            
            thetaSlider.addEventListener('input', (e) => {
                thetaValue.textContent = e.target.value;
            });
            
            phiSlider.addEventListener('input', (e) => {
                phiValue.textContent = e.target.value;
            });
            
            // Initial physics info
            updatePhysicsInfo(spinSlider.value);
            
            // Resize canvas to fill container
            function resizeCanvas() {
                const canvas = document.getElementById('canvas');
                const container = document.getElementById('container');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        run().catch(console.error);
    </script>
</body>
</html>
